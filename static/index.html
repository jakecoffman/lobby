<html>
<body>
<div id="messages"></div>
<label for="message">
    Message:
    <input id="message" name="message">
</label>
<button id="say" name="say" type="button" onclick="say()">Say</button>
<label for="name">
    Name:
    <input id="name" name="name">
</label>
<button id="changename" name="changename" type="button" onclick="changeName()">Change Name</button>
<script>
  var messages = document.getElementById('messages');
  var message = document.getElementById('message');

  var ws = new WebSocket([
    location.protocol === "https" ? "wss" : "ws",
    "://",
    location.hostname,
    ":",
    location.port,
    "/ws"].join(''));
  ws.isOpen = false;

  ws.onopen = function () {
    console.log("OPEN");
    ws.isOpen = true;
  };

  ws.onmessage = function (msg) {
    var json = JSON.parse(msg.data);
    console.log("Got message", json);
    switch (json.type) {
      case "say":
        var node = document.createTextNode(json.message);
        var p = document.createElement("p");
        p.appendChild(node);
        messages.appendChild(p);
        break;
      case "error":
        console.error(json.error);
        break;
      default:
        console.error("Unknown type", json);
    }
  };

  ws.onclose = function (msg) {
    console.log("CLOSED", msg);
  };

  ws.onerror = function (msg) {
    console.log("ERROR", msg);
  };

  function say() {
    var val = message.value;
    if (val === "") {
      return;
    }
    var msg = JSON.stringify({type: 0, cmd: {message: val}});
    console.log("Sending", msg);
    ws.send(msg);
    message.value = '';
  }

  function changeName() {
    var name = document.getElementById('name');
    var msg = JSON.stringify({type: 1, cmd: {message: name.value}});
    ws.send(msg)
  }

  document.getElementById("message")
    .addEventListener("keyup", function (event) {
      event.preventDefault();
      if (event.keyCode == 13) {
        document.getElementById("say").click();
      }
    });

</script>
</body>
</html>